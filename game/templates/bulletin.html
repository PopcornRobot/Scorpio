<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Bulletin</h1>
    <h4>User: {{ user }}</h4>
    <div style="border:1px solid black">
        <h4>Active Screen: <span id="activeScreen_old"></span></h4>
            <span id="activeScreen">
                
                {% include activeScreen %}
                
            </span> 
    </div>
    <h4>Nickname: {{ nickname }}</h4>
    <h4>Role: {{ role }}</h4>
    <h4>Informant: {{ informant }}</h4>
    <button onclick="getPlayerMessages('{{ user }}')">Get Messages</button>
    <h4>Messages: {{ messages }}</h4>
    <h4>Round: <span id="round"></span></h4>
    <h4>Timer: <span id="timer"></span></h4>
    <h4>Round 1: <span id="timer1"></span></h4>
    <h4>Round 2: <span id="timer2"></span></h4>
    <h4>Round 3: <span id="timer3"></span></h4>


    <script>
        
        // function myTimer() {
        //     console.log(' each 1 second...');
        // }

        // var myVar = setInterval(test, 1000);

        let player = "{{ user }}"
        console.log({player})
        polling = () => {
            console.log("polling start")
        //     setInterval(function() {getMessages()}, 2000)
            setInterval(function() {timer()}, 1000)
            setInterval(function() {checkPlayerScreen()}, 5000)
            // setInterval(function() {
            //     console.log("setInterval--------")
            //     test
            // }, 5000)
        }
        // getMessages = () => {
        //     console.log("getMessages")
        //     var xhttp = new XMLHttpRequest()
        //     xhttp.open("GET", "/getMessages", true)
        //     xhttp.send()
        // }
        timer = () => {
            var now = new Date().getTime() / 1000
            now = Math.round(now)
            var endTime1 = {{ roundOneEndTime }}
            var timeLeft1 = endTime1 - now 
            var min1 = Math.floor(timeLeft1/60)
            var sec1 = timeLeft1 % 60
            if(sec1 < 10) sec1 = "0"+sec1
            document.getElementById('timer1').innerHTML = min1+":"+sec1
            var endTime2 = {{ roundTwoEndTime }}
            var timeLeft2 = endTime2 - now 
            var min2 = Math.floor(timeLeft2/60)
            var sec2 = timeLeft2 % 60
            if(sec2 < 10) sec2 = "0"+sec2
            document.getElementById('timer2').innerHTML = min2+":"+sec2
            var endTime3 = {{ roundThreeEndTime }}
            var timeLeft3 = endTime3 - now 
            var min3 = Math.floor(timeLeft3/60)
            var sec3 = timeLeft2 % 60
            if(sec3 < 10) sec3 = "0"+sec3
            document.getElementById('timer3').innerHTML = min3+":"+sec3

            if(timeLeft1 > 0){
                document.getElementById('timer').innerHTML = min1+":"+sec1
                document.getElementById('round').innerHTML = 1
            } else if(timeLeft2 > 0){
                document.getElementById('timer').innerHTML = min2+":"+sec2
                document.getElementById('round').innerHTML = 2
            } else if(timeLeft3 > 0){
                document.getElementById('timer').innerHTML = min3+":"+sec3
                document.getElementById('round').innerHTML = 3    
            } else {
                document.getElementById('timer').innerHTML = "00:00"
                document.getElementById('round').innerHTML = "Game Over"
            }
       }
       getPlayerMessages = (user) => {
        //    const user = {{ user }}
           const url = "/getPlayerMessages/" + user
           fetch(url)
                .then(response => response.text())
                .then(data => console.log(data))
        
       }
       getPlayerScreen = () => {
           console.log("player----", player)
           const url  ="/getPlayerScreen/" + player
           fetch(url)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('activeScreen').innerHTML = data
                })
       }
    

       let playerActiveScreen = "{{ playerActiveScreen }}"
       checkPlayerScreen = () => {
           console.log("check player screen", playerActiveScreen)
           const url = "/checkPlayerScreen/" + player
           fetch(url)
                .then(response => response.text())
                .then(data => {
                    console.log({data}, {playerActiveScreen})
                    if(playerActiveScreen != data){
                        console.log("update screen")
                        getPlayerScreen()
                        playerActiveScreen = data
                    } else { 
                        console.log("no changes")
                    }
                })
       }
       document.onload(polling())
    </script>
</body>
</html>